"""
Advanced Vulnerability Detection Rules
Latest patterns for detecting security vulnerabilities including sensitive data exposure
"""

import re
from typing import Dict, List, Any, Optional, Tuple
from dataclasses import dataclass
from enum import Enum
import hashlib


class Severity(Enum):
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityCategory(Enum):
    SENSITIVE_DATA = "sensitive_data"
    INJECTION = "injection"
    AUTH = "authentication"
    CRYPTO = "cryptography"
    CONFIG = "configuration"
    XSS = "cross_site_scripting"
    XXE = "xml_external_entity"
    SSRF = "server_side_request_forgery"
    IDOR = "insecure_direct_object_reference"
    SECURITY_HEADERS = "security_headers"
    API_SECURITY = "api_security"
    CLOUD_CONFIG = "cloud_configuration"


@dataclass
class DetectionRule:
    """Vulnerability detection rule structure"""
    id: str
    name: str
    description: str
    category: VulnerabilityCategory
    severity: Severity
    pattern: str
    regex_flags: int = re.IGNORECASE | re.MULTILINE
    confidence: float = 1.0
    cwe_id: Optional[str] = None
    owasp_category: Optional[str] = None
    remediation: Optional[str] = None
    enabled: bool = True
    confidence_threshold: float = 0.7


class VulnerabilityDetector:
    """Advanced vulnerability detection engine"""

    def __init__(self):
        self.rules = self._initialize_rules()
        self.compiled_patterns = self._compile_patterns()

    def _initialize_rules(self) -> List[DetectionRule]:
        """Initialize comprehensive detection rules"""
        return [
            # ========== SENSITIVE DATA EXPOSURE RULES ==========

            # API Keys and Tokens
            DetectionRule(
                id="SENS-001",
                name="Generic API Key",
                description="Detects exposed API keys in various formats",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(api[_\-\s]?key|apikey|api_token|api[_\-\s]?secret)[\s]*[=:]\s*["\']?([a-zA-Z0-9\-_]{20,})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Remove API keys from code and use environment variables or secret management systems"
            ),

            # AWS Credentials
            DetectionRule(
                id="SENS-002",
                name="AWS Access Key",
                description="Detects exposed AWS access keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(aws[_\-\s]?access[_\-\s]?key[_\-\s]?id|aws_key_id|aws_access)[\s]*[=:]\s*["\']?(AKIA[0-9A-Z]{16})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use AWS IAM roles or AWS Secrets Manager instead of hardcoded credentials"
            ),

            DetectionRule(
                id="SENS-003",
                name="AWS Secret Key",
                description="Detects exposed AWS secret keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(aws[_\-\s]?secret[_\-\s]?access[_\-\s]?key|aws[_\-\s]?secret|secret[_\-\s]?key)[\s]*[=:]\s*["\']?([a-zA-Z0-9\+/]{40})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Never commit AWS secret keys. Use IAM roles or secrets management"
            ),

            # Google Cloud Credentials
            DetectionRule(
                id="SENS-004",
                name="Google API Key",
                description="Detects exposed Google API keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(google[_\-\s]?api[_\-\s]?key|gcp[_\-\s]?api[_\-\s]?key|g[_\-\s]?api[_\-\s]?key)[\s]*[=:]\s*["\']?(AIza[0-9A-Za-z\-_]{35})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use Google Cloud Secret Manager and restrict API key usage"
            ),

            DetectionRule(
                id="SENS-005",
                name="Google OAuth Token",
                description="Detects exposed Google OAuth tokens",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(google[_\-\s]?oauth|g[_\-\s]?oauth)[\s]*[=:]\s*["\']?([0-9]+-[0-9A-Za-z_]{32}\.apps\.googleusercontent\.com)["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use OAuth 2.0 flow properly without exposing tokens"
            ),

            # Azure Credentials
            DetectionRule(
                id="SENS-006",
                name="Azure Subscription Key",
                description="Detects exposed Azure subscription keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(azure[_\-\s]?subscription[_\-\s]?key|azure[_\-\s]?key)[\s]*[=:]\s*["\']?([a-f0-9]{32})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use Azure Key Vault for secrets management"
            ),

            # GitHub Token
            DetectionRule(
                id="SENS-007",
                name="GitHub Personal Access Token",
                description="Detects exposed GitHub tokens",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(github[_\-\s]?token|gh[_\-\s]?token|github[_\-\s]?pat)[\s]*[=:]\s*["\']?(ghp_[0-9a-zA-Z]{36}|github_pat_[0-9a-zA-Z]{22}_[0-9a-zA-Z]{59})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Revoke exposed tokens immediately and use GitHub Secrets"
            ),

            # Database Connection Strings
            DetectionRule(
                id="SENS-008",
                name="Database Connection String",
                description="Detects exposed database connection strings",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(mongodb|mysql|postgresql|postgres|mssql|oracle|redis):\/\/[^:]+:[^@]+@[^\/\s]+',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use environment variables for database credentials"
            ),

            # JWT Secrets
            DetectionRule(
                id="SENS-009",
                name="JWT Secret Key",
                description="Detects hardcoded JWT secret keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(jwt[_\-\s]?secret|jwt[_\-\s]?key|secret[_\-\s]?key)[\s]*[=:]\s*["\']?([a-zA-Z0-9\-_=]{16,})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Generate strong random JWT secrets and store securely"
            ),

            # Private Keys
            DetectionRule(
                id="SENS-010",
                name="RSA Private Key",
                description="Detects exposed RSA private keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'-----BEGIN\s+(?:RSA\s+)?PRIVATE\s+KEY-----',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Never commit private keys. Use key management systems"
            ),

            DetectionRule(
                id="SENS-011",
                name="SSH Private Key",
                description="Detects exposed SSH private keys",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'-----BEGIN\s+(?:OPENSSH\s+)?(?:RSA\s+)?(?:DSA\s+)?(?:EC\s+)?PRIVATE\s+KEY-----',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use SSH agent and never commit private keys"
            ),

            # Credit Card Information
            DetectionRule(
                id="SENS-012",
                name="Credit Card Number",
                description="Detects exposed credit card numbers",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'\b(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|6(?:011|5[0-9]{2})[0-9]{12}|(?:2131|1800|35\d{3})\d{11})\b',
                cwe_id="CWE-359",
                owasp_category="A02:2021",
                remediation="Use PCI-compliant payment processing and tokenization"
            ),

            # Social Security Numbers
            DetectionRule(
                id="SENS-013",
                name="Social Security Number",
                description="Detects exposed SSN patterns",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.CRITICAL,
                pattern=r'\b(?!000|666|9\d{2})\d{3}[-\s]?(?!00)\d{2}[-\s]?(?!0000)\d{4}\b',
                cwe_id="CWE-359",
                owasp_category="A02:2021",
                remediation="Encrypt PII and implement access controls"
            ),

            # Email Passwords
            DetectionRule(
                id="SENS-014",
                name="Email Service Credentials",
                description="Detects SMTP/email service passwords",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(smtp[_\-\s]?password|mail[_\-\s]?password|email[_\-\s]?password|sendgrid[_\-\s]?key|mailgun[_\-\s]?key)[\s]*[=:]\s*["\']?([^\s"\']{8,})["\']?',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Use OAuth or app-specific passwords for email services"
            ),

            # Slack/Discord Tokens
            DetectionRule(
                id="SENS-015",
                name="Slack Token",
                description="Detects exposed Slack tokens",
                category=VulnerabilityCategory.SENSITIVE_DATA,
                severity=Severity.HIGH,
                pattern=r'(?i)(xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24,34})',
                cwe_id="CWE-798",
                owasp_category="A02:2021",
                remediation="Rotate Slack tokens and use OAuth properly"
            ),

            # ========== INJECTION VULNERABILITIES ==========

            DetectionRule(
                id="INJ-001",
                name="SQL Injection Pattern",
                description="Detects potential SQL injection vulnerabilities",
                category=VulnerabilityCategory.INJECTION,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(select|insert|update|delete|drop|union|exec|execute|declare|create|alter)\s+.*\s+(from|into|where|set|table|database|procedure).*[\+\'\"\-\-\s]',
                cwe_id="CWE-89",
                owasp_category="A03:2021",
                remediation="Use parameterized queries and prepared statements"
            ),

            DetectionRule(
                id="INJ-002",
                name="NoSQL Injection Pattern",
                description="Detects potential NoSQL injection patterns",
                category=VulnerabilityCategory.INJECTION,
                severity=Severity.HIGH,
                pattern=r'(?i)(\$where|\$ne|\$gt|\$lt|\$gte|\$lte|\$regex|\$exists|\$in|\$nin)[\s]*:',
                cwe_id="CWE-943",
                owasp_category="A03:2021",
                remediation="Validate and sanitize NoSQL queries"
            ),

            DetectionRule(
                id="INJ-003",
                name="Command Injection Pattern",
                description="Detects potential command injection",
                category=VulnerabilityCategory.INJECTION,
                severity=Severity.CRITICAL,
                pattern=r'(?i)(exec|system|eval|passthru|shell_exec|popen|proc_open|pcntl_exec|assert|create_function|include|require|file_get_contents|file_put_contents|fopen|readfile)[\s]*\(',
                cwe_id="CWE-78",
                owasp_category="A03:2021",
                remediation="Never pass user input to system commands"
            ),

            DetectionRule(
                id="INJ-004",
                name="LDAP Injection Pattern",
                description="Detects potential LDAP injection",
                category=VulnerabilityCategory.INJECTION,
                severity=Severity.HIGH,
                pattern=r'(?i)(\(|\)|\||&|!|\*|=|~|>=|<=|\+|\-)',
                cwe_id="CWE-90",
                owasp_category="A03:2021",
                remediation="Escape special characters in LDAP queries"
            ),

            DetectionRule(
                id="INJ-005",
                name="XPath Injection Pattern",
                description="Detects potential XPath injection",
                category=VulnerabilityCategory.INJECTION,
                severity=Severity.HIGH,
                pattern=r'(?i)(descendant::|ancestor::|child::|parent::|following::|preceding::|attribute::|\[|\]|\/\/|\.\.)',
                cwe_id="CWE-643",
                owasp_category="A03:2021",
                remediation="Use parameterized XPath queries"
            ),

            # ========== AUTHENTICATION & AUTHORIZATION ==========

            DetectionRule(
                id="AUTH-001",
                name="Weak Password Pattern",
                description="Detects weak or default passwords",
                category=VulnerabilityCategory.AUTH,
                severity=Severity.HIGH,
                pattern=r'(?i)(password|passwd|pwd)[\s]*[=:]\s*["\']?(admin|password|123456|12345678|qwerty|abc123|monkey|1234567|letmein|trustno1|dragon|baseball|111111|iloveyou|master|sunshine|ashley|bailey|passw0rd|shadow|123123|654321|superman|password1)["\']?',
                cwe_id="CWE-521",
                owasp_category="A07:2021",
                remediation="Enforce strong password policies"
            ),

            DetectionRule(
                id="AUTH-002",
                name="Basic Authentication Header",
                description="Detects hardcoded basic auth credentials",
                category=VulnerabilityCategory.AUTH,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(authorization|auth)[\s]*[=:]\s*["\']?(basic\s+[a-zA-Z0-9\+/=]{10,})["\']?',
                cwe_id="CWE-522",
                owasp_category="A07:2021",
                remediation="Use OAuth 2.0 or modern authentication methods"
            ),

            DetectionRule(
                id="AUTH-003",
                name="Hardcoded Username",
                description="Detects hardcoded usernames",
                category=VulnerabilityCategory.AUTH,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(user|username|login|email)[\s]*[=:]\s*["\']?(admin|root|test|guest|demo|oracle|postgres|mysql|web|www)["\']?',
                cwe_id="CWE-798",
                owasp_category="A07:2021",
                remediation="Use secure credential management"
            ),

            # ========== CRYPTOGRAPHIC ISSUES ==========

            DetectionRule(
                id="CRYPTO-001",
                name="Weak Cryptographic Algorithm",
                description="Detects usage of weak crypto algorithms",
                category=VulnerabilityCategory.CRYPTO,
                severity=Severity.HIGH,
                pattern=r'(?i)(md5|sha1|des|rc4|rc2)[\s]*\(',
                cwe_id="CWE-327",
                owasp_category="A02:2021",
                remediation="Use strong algorithms like SHA-256, AES-256"
            ),

            DetectionRule(
                id="CRYPTO-002",
                name="Hardcoded Encryption Key",
                description="Detects hardcoded encryption keys",
                category=VulnerabilityCategory.CRYPTO,
                severity=Severity.HIGH,
                pattern=r'(?i)(encryption[_\-\s]?key|crypto[_\-\s]?key|cipher[_\-\s]?key)[\s]*[=:]\s*["\']?([a-fA-F0-9]{16,})["\']?',
                cwe_id="CWE-321",
                owasp_category="A02:2021",
                remediation="Use key management systems"
            ),

            DetectionRule(
                id="CRYPTO-003",
                name="Hardcoded Salt",
                description="Detects hardcoded cryptographic salts",
                category=VulnerabilityCategory.CRYPTO,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(salt)[\s]*[=:]\s*["\']?([a-zA-Z0-9]{8,})["\']?',
                cwe_id="CWE-760",
                owasp_category="A02:2021",
                remediation="Generate random salts for each operation"
            ),

            # ========== SECURITY MISCONFIGURATIONS ==========

            DetectionRule(
                id="CONFIG-001",
                name="Debug Mode Enabled",
                description="Detects debug mode in production",
                category=VulnerabilityCategory.CONFIG,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(debug|DEBUG)[\s]*[=:]\s*["\']?(true|on|1|enabled)["\']?',
                cwe_id="CWE-489",
                owasp_category="A05:2021",
                remediation="Disable debug mode in production"
            ),

            DetectionRule(
                id="CONFIG-002",
                name="Directory Listing Enabled",
                description="Detects directory listing configuration",
                category=VulnerabilityCategory.CONFIG,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(Options\s+\+?Indexes|autoindex\s+on|directory[_\-\s]?listing[\s]*[=:]\s*["\']?true)',
                cwe_id="CWE-548",
                owasp_category="A05:2021",
                remediation="Disable directory listing"
            ),

            DetectionRule(
                id="CONFIG-003",
                name="Insecure CORS Configuration",
                description="Detects overly permissive CORS settings",
                category=VulnerabilityCategory.CONFIG,
                severity=Severity.HIGH,
                pattern=r'(?i)(access[_\-\s]?control[_\-\s]?allow[_\-\s]?origin)[\s]*[=:]\s*["\']?\*["\']?',
                cwe_id="CWE-942",
                owasp_category="A05:2021",
                remediation="Configure CORS with specific allowed origins"
            ),

            # ========== XSS PATTERNS ==========

            DetectionRule(
                id="XSS-001",
                name="Reflected XSS Pattern",
                description="Detects potential reflected XSS",
                category=VulnerabilityCategory.XSS,
                severity=Severity.HIGH,
                pattern=r'(?i)(<script[^>]*>|javascript:|onerror=|onload=|onclick=|onmouseover=|onfocus=|onblur=)',
                cwe_id="CWE-79",
                owasp_category="A03:2021",
                remediation="Sanitize all user input and use CSP headers"
            ),

            DetectionRule(
                id="XSS-002",
                name="DOM XSS Pattern",
                description="Detects potential DOM-based XSS",
                category=VulnerabilityCategory.XSS,
                severity=Severity.HIGH,
                pattern=r'(?i)(document\.write|innerHTML|outerHTML|eval|setTimeout|setInterval|Function)\s*\(',
                cwe_id="CWE-79",
                owasp_category="A03:2021",
                remediation="Use safe DOM manipulation methods"
            ),

            # ========== API SECURITY ==========

            DetectionRule(
                id="API-001",
                name="GraphQL Introspection Enabled",
                description="Detects GraphQL introspection in production",
                category=VulnerabilityCategory.API_SECURITY,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(__schema|__type|introspection[\s]*[=:]\s*["\']?true)',
                cwe_id="CWE-200",
                owasp_category="API1:2023",
                remediation="Disable GraphQL introspection in production"
            ),

            DetectionRule(
                id="API-002",
                name="API Rate Limiting Missing",
                description="Detects missing rate limiting configuration",
                category=VulnerabilityCategory.API_SECURITY,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(rate[_\-\s]?limit|throttle)[\s]*[=:]\s*["\']?(false|off|0|disabled|none)["\']?',
                cwe_id="CWE-770",
                owasp_category="API4:2023",
                remediation="Implement API rate limiting"
            ),

            # ========== CLOUD MISCONFIGURATIONS ==========

            DetectionRule(
                id="CLOUD-001",
                name="S3 Bucket Public Access",
                description="Detects public S3 bucket configurations",
                category=VulnerabilityCategory.CLOUD_CONFIG,
                severity=Severity.HIGH,
                pattern=r'(?i)(BlockPublicAcls|BlockPublicPolicy|IgnorePublicAcls|RestrictPublicBuckets)[\s]*[=:]\s*["\']?(false|no|0)["\']?',
                cwe_id="CWE-732",
                owasp_category="A05:2021",
                remediation="Enable S3 bucket public access blocking"
            ),

            DetectionRule(
                id="CLOUD-002",
                name="Unencrypted Cloud Storage",
                description="Detects unencrypted cloud storage configuration",
                category=VulnerabilityCategory.CLOUD_CONFIG,
                severity=Severity.HIGH,
                pattern=r'(?i)(encryption|encrypted|sse[_\-\s]?enabled)[\s]*[=:]\s*["\']?(false|no|0|disabled)["\']?',
                cwe_id="CWE-311",
                owasp_category="A02:2021",
                remediation="Enable encryption for cloud storage"
            ),

            # ========== SSRF PATTERNS ==========

            DetectionRule(
                id="SSRF-001",
                name="SSRF URL Pattern",
                description="Detects potential SSRF vulnerabilities",
                category=VulnerabilityCategory.SSRF,
                severity=Severity.HIGH,
                pattern=r'(?i)(localhost|127\.0\.0\.1|0\.0\.0\.0|169\.254\.169\.254|metadata\.google|metadata\.azure|ecs\.amazonaws)',
                cwe_id="CWE-918",
                owasp_category="A10:2021",
                remediation="Validate and whitelist allowed URLs"
            ),

            # ========== IDOR PATTERNS ==========

            DetectionRule(
                id="IDOR-001",
                name="Sequential ID Pattern",
                description="Detects potential IDOR with sequential IDs",
                category=VulnerabilityCategory.IDOR,
                severity=Severity.MEDIUM,
                pattern=r'(?i)(/user/|/account/|/order/|/document/|/file/)(\d{1,10}|\{id\}|\[id\])',
                cwe_id="CWE-639",
                owasp_category="A01:2021",
                remediation="Use UUIDs and implement proper access controls"
            ),

            # ========== SECURITY HEADERS ==========

            DetectionRule(
                id="HEADER-001",
                name="Missing Security Headers",
                description="Detects missing security headers",
                category=VulnerabilityCategory.SECURITY_HEADERS,
                severity=Severity.LOW,
                pattern=r'(?i)^(?!.*(X-Frame-Options|X-Content-Type-Options|X-XSS-Protection|Strict-Transport-Security|Content-Security-Policy)).*$',
                cwe_id="CWE-693",
                owasp_category="A05:2021",
                remediation="Implement security headers"
            ),
        ]

    def _compile_patterns(self) -> Dict[str, re.Pattern]:
        """Compile regex patterns for performance"""
        compiled = {}
        for rule in self.rules:
            try:
                compiled[rule.id] = re.compile(rule.pattern, rule.regex_flags)
            except re.error as e:
                print(f"Error compiling pattern for rule {rule.id}: {e}")
        return compiled

    def scan_content(self, content: str, context: Optional[Dict[str, Any]] = None) -> List[Dict[str, Any]]:
        """
        Scan content for vulnerabilities

        Args:
            content: The content to scan
            context: Optional context information (url, filename, etc.)

        Returns:
            List of detected vulnerabilities
        """
        findings = []

        for rule in self.rules:
            if rule.id not in self.compiled_patterns:
                continue

            pattern = self.compiled_patterns[rule.id]
            matches = pattern.finditer(content)

            for match in matches:
                # Calculate line number
                line_num = content[:match.start()].count('\n') + 1

                # Extract matched content (limit to 200 chars)
                matched_text = match.group(0)[:200]

                # Create finding
                finding = {
                    "rule_id": rule.id,
                    "name": rule.name,
                    "description": rule.description,
                    "category": rule.category.value,
                    "severity": rule.severity.value,
                    "confidence": rule.confidence,
                    "line": line_num,
                    "matched_text": matched_text,
                    "cwe_id": rule.cwe_id,
                    "owasp_category": rule.owasp_category,
                    "remediation": rule.remediation,
                    "context": context or {}
                }

                # Add position information
                finding["position"] = {
                    "start": match.start(),
                    "end": match.end()
                }

                findings.append(finding)

        return findings

    def scan_file(self, filepath: str) -> List[Dict[str, Any]]:
        """Scan a file for vulnerabilities"""
        try:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read()

            context = {
                "filename": filepath,
                "file_type": self._detect_file_type(filepath)
            }

            return self.scan_content(content, context)
        except Exception as e:
            return [{
                "error": str(e),
                "filename": filepath,
                "severity": "error"
            }]

    def _detect_file_type(self, filepath: str) -> str:
        """Detect file type based on extension"""
        extensions_map = {
            '.py': 'python',
            '.js': 'javascript',
            '.ts': 'typescript',
            '.java': 'java',
            '.php': 'php',
            '.rb': 'ruby',
            '.go': 'go',
            '.c': 'c',
            '.cpp': 'cpp',
            '.cs': 'csharp',
            '.yaml': 'yaml',
            '.yml': 'yaml',
            '.json': 'json',
            '.xml': 'xml',
            '.env': 'environment',
            '.config': 'config',
            '.conf': 'config',
            '.ini': 'ini',
            '.properties': 'properties'
        }

        import os
        _, ext = os.path.splitext(filepath.lower())
        return extensions_map.get(ext, 'unknown')

    def get_rules_by_category(self, category: VulnerabilityCategory) -> List[DetectionRule]:
        """Get all rules for a specific category"""
        return [rule for rule in self.rules if rule.category == category]

    def get_rules_by_severity(self, severity: Severity) -> List[DetectionRule]:
        """Get all rules for a specific severity"""
        return [rule for rule in self.rules if rule.severity == severity]

    def generate_report(self, findings: List[Dict[str, Any]]) -> Dict[str, Any]:
        """Generate a vulnerability report from findings"""
        report = {
            "total_findings": len(findings),
            "severity_breakdown": {},
            "category_breakdown": {},
            "top_vulnerabilities": [],
            "risk_score": 0
        }

        # Count by severity
        for severity in Severity:
            count = len([f for f in findings if f["severity"] == severity.value])
            report["severity_breakdown"][severity.value] = count

        # Count by category
        for category in VulnerabilityCategory:
            count = len([f for f in findings if f["category"] == category.value])
            if count > 0:
                report["category_breakdown"][category.value] = count

        # Calculate risk score
        severity_weights = {
            Severity.CRITICAL.value: 10,
            Severity.HIGH.value: 7,
            Severity.MEDIUM.value: 4,
            Severity.LOW.value: 2,
            Severity.INFO.value: 1
        }

        for finding in findings:
            report["risk_score"] += severity_weights.get(finding["severity"], 0)

        # Get top vulnerabilities
        critical_high = [f for f in findings if f["severity"] in [Severity.CRITICAL.value, Severity.HIGH.value]]
        report["top_vulnerabilities"] = critical_high[:10]

        return report


# Create global detector instance
vulnerability_detector = VulnerabilityDetector()