"""
Tests for Vulnerability Merger
"""

from app.services.vulnerability_merger import VulnerabilityMerger


class TestVulnerabilityMerger:
    """Test vulnerability merging and deduplication"""

    def test_normalize_name(self):
        """Test vulnerability name normalization"""
        merger = VulnerabilityMerger()
        
        # Test basic normalization
        assert merger.normalize_name("SQL Injection [HIGH]") == "sql injection"
        assert merger.normalize_name("  XSS Vulnerability  ") == "xss"
        assert merger.normalize_name("Detected: CSRF Token") == "csrf token"
        
    def test_extract_cve_id(self):
        """Test CVE ID extraction from various fields"""
        merger = VulnerabilityMerger()
        
        # Direct field
        vuln1 = {"cve_id": "2021-44228"}
        assert merger.extract_cve_id(vuln1) == "CVE-2021-44228"
        
        # From tags
        vuln2 = {"tags": ["cve-2021-44228", "rce"]}
        assert merger.extract_cve_id(vuln2) == "CVE-2021-44228"
        
        # From description
        vuln3 = {"description": "Apache Log4j CVE-2021-44228 RCE vulnerability"}
        assert merger.extract_cve_id(vuln3) == "CVE-2021-44228"
        
        # No CVE
        vuln4 = {"name": "Generic SQL Injection"}
        assert merger.extract_cve_id(vuln4) is None

    def test_create_fingerprint(self):
        """Test fingerprint creation"""
        merger = VulnerabilityMerger()
        
        vuln = {
            "name": "SQL Injection",
            "host": "example.com",
            "path": "/api/users",
            "severity": "high"
        }
        
        fp = merger.create_fingerprint(vuln)
        
        assert fp.name_normalized == "sql injection"
        assert fp.host == "example.com"
        assert fp.severity == "high"
        assert "/api/users" in fp.location

    def test_simple_duplicate_detection(self):
        """Test detection of exact duplicates"""
        merger = VulnerabilityMerger()
        
        vuln1 = {
            "name": "SQL Injection",
            "host": "example.com",
            "severity": "high",
            "description": "SQL injection in login form"
        }
        
        vuln2 = {
            "name": "SQL Injection",
            "host": "example.com",
            "severity": "high",
            "description": "SQL injection detected"
        }
        
        # Add both vulnerabilities
        key1 = merger.add_vulnerability(vuln1, "nuclei")
        key2 = merger.add_vulnerability(vuln2, "zap")
        
        # Should be merged into one
        assert key1 == key2
        assert len(merger.merged_vulns) == 1
        
        # Check merged data
        merged_vulns = merger.get_merged_vulnerabilities()
        assert len(merged_vulns) == 1
        assert merged_vulns[0]['merger_metadata']['detection_count'] == 2
        assert 'nuclei' in merged_vulns[0]['merger_metadata']['sources']
        assert 'zap' in merged_vulns[0]['merger_metadata']['sources']

    def test_similarity_based_merging(self):
        """Test fuzzy matching for similar vulnerabilities"""
        merger = VulnerabilityMerger()
        
        vuln1 = {
            "name": "Cross Site Scripting (XSS)",
            "host": "example.com",
            "path": "/search",
            "severity": "medium",
            "cve_id": "CVE-2023-12345"
        }
        
        vuln2 = {
            "name": "XSS Vulnerability Detected",
            "host": "example.com",
            "path": "/search",
            "severity": "high",
            "cve_id": "CVE-2023-12345"
        }
        
        merger.add_vulnerability(vuln1, "nuclei")
        merger.add_vulnerability(vuln2, "pattern_detection")
        
        # Should be merged due to same CVE and similar characteristics
        merged_vulns = merger.get_merged_vulnerabilities()
        assert len(merged_vulns) == 1
        
        # Should prefer higher severity
        assert merged_vulns[0]['severity'] == 'high'

    def test_severity_preference(self):
        """Test that higher severity is preferred when merging"""
        merger = VulnerabilityMerger()
        
        vuln_low = {
            "name": "CSRF",
            "host": "test.com",
            "severity": "low"
        }
        
        vuln_critical = {
            "name": "CSRF",
            "host": "test.com",
            "severity": "critical"
        }
        
        merger.add_vulnerability(vuln_low, "custom")
        merger.add_vulnerability(vuln_critical, "nuclei")
        
        merged_vulns = merger.get_merged_vulnerabilities()
        assert len(merged_vulns) == 1
        assert merged_vulns[0]['severity'] == 'critical'

    def test_metadata_merging(self):
        """Test that metadata from multiple sources is combined"""
        merger = VulnerabilityMerger()
        
        vuln1 = {
            "name": "Open Redirect",
            "host": "app.example.com",
            "severity": "medium",
            "reference": ["https://cwe.mitre.org/data/definitions/601.html"],
            "tags": ["redirect", "owasp"]
        }
        
        vuln2 = {
            "name": "Open Redirect",
            "host": "app.example.com",
            "severity": "medium",
            "reference": ["https://owasp.org/www-community/attacks/Open_Redirect"],
            "tags": ["redirect", "web"],
            "remediation": "Validate all redirects"
        }
        
        merger.add_vulnerability(vuln1, "nuclei")
        merger.add_vulnerability(vuln2, "zap")
        
        merged_vulns = merger.get_merged_vulnerabilities()
        assert len(merged_vulns) == 1
        
        merged = merged_vulns[0]
        
        # Should have combined references
        assert len(merged['reference']) == 2
        assert "cwe.mitre.org" in str(merged['reference'])
        assert "owasp.org" in str(merged['reference'])
        
        # Should have combined tags
        assert len(merged['tags']) == 3  # redirect, owasp, web
        
        # Should have remediation from vuln2
        assert merged.get('remediation') == "Validate all redirects"

    def test_confidence_scoring(self):
        """Test confidence score calculation"""
        merger = VulnerabilityMerger()
        
        vuln = {
            "name": "Apache Struts RCE",
            "host": "server.example.com",
            "severity": "critical",
            "cve_id": "CVE-2017-5638",
            "cwe_id": "CWE-20"
        }
        
        # Add from single low-confidence source
        merger.add_vulnerability(vuln.copy(), "custom")
        merged = list(merger.merged_vulns.values())[0]
        initial_confidence = merged.confidence_score
        
        # Add from high-confidence source
        merger.add_vulnerability(vuln.copy(), "nuclei")
        
        merged_vulns = merger.get_merged_vulnerabilities()
        final_confidence = merged_vulns[0]['merger_metadata']['confidence_score']
        
        # Confidence should increase with multiple detections and high-confidence sources
        assert final_confidence > initial_confidence
        assert final_confidence > 0.5  # Should be reasonably high

    def test_different_vulnerabilities_not_merged(self):
        """Test that actually different vulnerabilities are not merged"""
        merger = VulnerabilityMerger()
        
        vuln1 = {
            "name": "SQL Injection",
            "host": "api.example.com",
            "path": "/users",
            "severity": "high"
        }
        
        vuln2 = {
            "name": "XSS",
            "host": "api.example.com",
            "path": "/search",
            "severity": "medium"
        }
        
        merger.add_vulnerability(vuln1, "nuclei")
        merger.add_vulnerability(vuln2, "zap")
        
        # Should remain separate
        merged_vulns = merger.get_merged_vulnerabilities()
        assert len(merged_vulns) == 2

    def test_statistics(self):
        """Test merger statistics calculation"""
        merger = VulnerabilityMerger()
        
        vulns = [
            {"name": "SQLi", "host": "host1", "severity": "high"},
            {"name": "SQLi", "host": "host1", "severity": "high"},  # Duplicate
            {"name": "XSS", "host": "host2", "severity": "medium"},
            {"name": "CSRF", "host": "host3", "severity": "low"},
        ]
        
        merger.add_vulnerability(vulns[0], "nuclei")
        merger.add_vulnerability(vulns[1], "zap")
        merger.add_vulnerability(vulns[2], "pattern_detection")
        merger.add_vulnerability(vulns[3], "custom")
        
        stats = merger.get_statistics()
        
        assert stats['total_unique_vulnerabilities'] == 3
        assert stats['multi_source_detections'] == 1  # Only SQLi detected by multiple sources
        assert stats['by_severity']['high'] == 1
        assert stats['by_severity']['medium'] == 1
        assert stats['by_severity']['low'] == 1

    def test_min_confidence_filtering(self):
        """Test filtering by minimum confidence score"""
        merger = VulnerabilityMerger()
        
        # Low confidence vulnerability
        vuln1 = {"name": "Info Disclosure", "host": "test.com", "severity": "info"}
        merger.add_vulnerability(vuln1, "custom")  # Low weight source
        
        # High confidence vulnerability
        vuln2 = {"name": "RCE", "host": "test.com", "severity": "critical", "cve_id": "CVE-2023-1234"}
        merger.add_vulnerability(vuln2, "nuclei")  # High weight source
        merger.add_vulnerability(vuln2.copy(), "zap")  # Multiple sources
        
        # Get only high-confidence vulnerabilities
        high_conf_vulns = merger.get_merged_vulnerabilities(min_confidence=0.5)
        
        # Should filter out low-confidence vulnerability
        assert len(high_conf_vulns) == 1
        assert high_conf_vulns[0]['name'] == 'RCE'

    def test_sorting_options(self):
        """Test different sorting options"""
        merger = VulnerabilityMerger()
        
        vulns = [
            {"name": "Info", "host": "h1", "severity": "info"},
            {"name": "Critical", "host": "h2", "severity": "critical"},
            {"name": "Medium", "host": "h3", "severity": "medium"},
        ]
        
        for vuln in vulns:
            merger.add_vulnerability(vuln, "nuclei")
        
        # Sort by severity (default)
        by_severity = merger.get_merged_vulnerabilities(sort_by='severity')
        assert by_severity[0]['severity'] == 'critical'
        assert by_severity[-1]['severity'] == 'info'
        
        # Add a duplicate to test detection_count sorting
        merger.add_vulnerability(vulns[0], "zap")
        
        by_detection = merger.get_merged_vulnerabilities(sort_by='detection_count')
        assert by_detection[0]['merger_metadata']['detection_count'] == 2
