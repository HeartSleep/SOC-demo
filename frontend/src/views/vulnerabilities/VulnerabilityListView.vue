<template>
  <div class="vulnerability-list">
    <div class="page-header">
      <h1>漏洞管理</h1>
      <p>管理和跟踪发现的安全漏洞</p>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <el-button
          @click="handleBulkVerify"
          :disabled="selectedVulns.length === 0"
        >
          <el-icon><Check /></el-icon>
          批量验证
        </el-button>
        <el-button
          type="warning"
          @click="handleBulkIgnore"
          :disabled="selectedVulns.length === 0"
        >
          <el-icon><Hide /></el-icon>
          批量忽略
        </el-button>
        <el-button
          type="success"
          @click="handleBulkFix"
          :disabled="selectedVulns.length === 0"
        >
          <el-icon><CircleCheck /></el-icon>
          标记已修复
        </el-button>
        <el-button
          type="info"
          @click="exportVulnerabilities"
        >
          <el-icon><Download /></el-icon>
          导出报告
        </el-button>
      </div>

      <div class="toolbar-right">
        <el-input
          v-model="searchQuery"
          placeholder="搜索漏洞..."
          prefix-icon="Search"
          clearable
          @input="handleSearch"
        />
        <el-select v-model="severityFilter" placeholder="严重程度" clearable>
          <el-option label="全部" value="" />
          <el-option label="严重" value="critical" />
          <el-option label="高危" value="high" />
          <el-option label="中危" value="medium" />
          <el-option label="低危" value="low" />
        </el-select>
        <el-select v-model="statusFilter" placeholder="状态" clearable>
          <el-option label="全部" value="" />
          <el-option label="待修复" value="open" />
          <el-option label="已修复" value="fixed" />
          <el-option label="误报" value="false_positive" />
          <el-option label="已忽略" value="ignored" />
        </el-select>
        <el-date-picker
          v-model="dateRange"
          type="daterange"
          range-separator="至"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          @change="handleDateChange"
        />
      </div>
    </div>

    <!-- Statistics Cards -->
    <el-row :gutter="16" class="stats-row">
      <el-col :xs="12" :sm="6">
        <el-card class="stat-card critical">
          <div class="stat-content">
            <div class="stat-number">{{ stats.critical }}</div>
            <div class="stat-label">严重漏洞</div>
          </div>
          <el-icon class="stat-icon"><Warning /></el-icon>
        </el-card>
      </el-col>
      <el-col :xs="12" :sm="6">
        <el-card class="stat-card high">
          <div class="stat-content">
            <div class="stat-number">{{ stats.high }}</div>
            <div class="stat-label">高危漏洞</div>
          </div>
          <el-icon class="stat-icon"><Warning /></el-icon>
        </el-card>
      </el-col>
      <el-col :xs="12" :sm="6">
        <el-card class="stat-card medium">
          <div class="stat-content">
            <div class="stat-number">{{ stats.medium }}</div>
            <div class="stat-label">中危漏洞</div>
          </div>
          <el-icon class="stat-icon"><Warning /></el-icon>
        </el-card>
      </el-col>
      <el-col :xs="12" :sm="6">
        <el-card class="stat-card low">
          <div class="stat-content">
            <div class="stat-number">{{ stats.low }}</div>
            <div class="stat-label">低危漏洞</div>
          </div>
          <el-icon class="stat-icon"><Warning /></el-icon>
        </el-card>
      </el-col>
    </el-row>

    <el-card>
      <el-table
        :data="vulnerabilities"
        v-loading="loading"
        @selection-change="handleSelectionChange"
        stripe
        :row-class-name="getRowClassName"
      >
        <el-table-column type="selection" width="55" />

        <el-table-column prop="name" label="漏洞名称" min-width="250">
          <template #default="{ row }">
            <div class="vuln-name">
              <router-link :to="`/vulnerabilities/${row.id}`" class="vuln-link">
                {{ row.name }}
              </router-link>
              <div v-if="row.cve_id" class="cve-id">{{ row.cve_id }}</div>
            </div>
          </template>
        </el-table-column>

        <el-table-column prop="severity" label="严重程度" width="100">
          <template #default="{ row }">
            <el-tag :type="getSeverityTagType(row.severity)">
              {{ getSeverityLabel(row.severity) }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="cvss_score" label="CVSS评分" width="100">
          <template #default="{ row }">
            <div class="cvss-score">
              <span>{{ row.cvss_score || 'N/A' }}</span>
            </div>
          </template>
        </el-table-column>

        <el-table-column prop="asset_name" label="影响资产" min-width="150">
          <template #default="{ row }">
            <router-link :to="`/assets/${row.asset_id}`" class="asset-link">
              {{ row.asset_name }}
            </router-link>
          </template>
        </el-table-column>

        <el-table-column prop="status" label="状态" width="100">
          <template #default="{ row }">
            <el-tag :type="getStatusTagType(row.status)" size="small">
              {{ getStatusLabel(row.status) }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="verified" label="验证状态" width="100">
          <template #default="{ row }">
            <el-tag
              :type="row.verified ? 'success' : 'warning'"
              size="small"
            >
              {{ row.verified ? '已验证' : '未验证' }}
            </el-tag>
          </template>
        </el-table-column>

        <el-table-column prop="discovered_at" label="发现时间" width="150">
          <template #default="{ row }">
            {{ formatDate(row.discovered_at) }}
          </template>
        </el-table-column>

        <el-table-column prop="task_name" label="扫描任务" width="150">
          <template #default="{ row }">
            <router-link
              v-if="row.task_id"
              :to="`/tasks/${row.task_id}`"
              class="task-link"
            >
              {{ row.task_name }}
            </router-link>
            <span v-else>-</span>
          </template>
        </el-table-column>

        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button
              v-if="!row.verified"
              type="primary"
              size="small"
              @click="handleVerify(row)"
            >
              验证
            </el-button>
            <el-button
              v-if="row.status === 'open'"
              type="success"
              size="small"
              @click="handleMarkFixed(row)"
            >
              已修复
            </el-button>
            <el-button
              size="small"
              @click="$router.push(`/vulnerabilities/${row.id}`)"
            >
              详情
            </el-button>
            <el-dropdown @command="(cmd) => handleCommand(cmd, row)">
              <el-button size="small" type="info">
                更多<el-icon><ArrowDown /></el-icon>
              </el-button>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="ignore">忽略</el-dropdown-item>
                  <el-dropdown-item command="false_positive">标记误报</el-dropdown-item>
                  <el-dropdown-item command="assign">分配处理</el-dropdown-item>
                  <el-dropdown-item command="export" divided>导出</el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </template>
        </el-table-column>
      </el-table>

      <div class="pagination">
        <el-pagination
          v-model:current-page="currentPage"
          v-model:page-size="pageSize"
          :total="total"
          :page-sizes="[10, 20, 50, 100]"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>

    <!-- Assign Dialog -->
    <el-dialog
      v-model="assignDialogVisible"
      title="分配漏洞处理"
      width="500px"
    >
      <el-form :model="assignForm" label-width="80px">
        <el-form-item label="处理人员">
          <el-select v-model="assignForm.assignee" placeholder="选择处理人员">
            <el-option
              v-for="user in users"
              :key="user.id"
              :label="user.full_name"
              :value="user.id"
            />
          </el-select>
        </el-form-item>
        <el-form-item label="优先级">
          <el-select v-model="assignForm.priority">
            <el-option label="低" value="low" />
            <el-option label="中" value="medium" />
            <el-option label="高" value="high" />
            <el-option label="紧急" value="urgent" />
          </el-select>
        </el-form-item>
        <el-form-item label="备注">
          <el-input
            v-model="assignForm.notes"
            type="textarea"
            :rows="3"
            placeholder="添加处理说明或备注"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="assignDialogVisible = false">取消</el-button>
        <el-button type="primary" @click="confirmAssign">确定分配</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, toRefs } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useVulnerabilityStore } from '@/store/vulnerability'
import { useUserStore } from '@/store/user'
import { formatDate } from '@/utils/date'

const vulnerabilityStore = useVulnerabilityStore()
const userStore = useUserStore()

const loading = ref(false)
const vulnerabilities = ref([])
const selectedVulns = ref([])
const searchQuery = ref('')
const severityFilter = ref('')
const statusFilter = ref('')
const dateRange = ref([])

const pagination = reactive({
  currentPage: 1,
  pageSize: 20,
  total: 0
})

const stats = reactive({
  critical: 0,
  high: 0,
  medium: 0,
  low: 0
})

const assignDialogVisible = ref(false)
const assignForm = reactive({
  vulnerability_id: null,
  assignee: null,
  priority: 'medium',
  notes: ''
})

const users = ref([])

const { currentPage, pageSize, total } = toRefs(pagination)

onMounted(() => {
  fetchVulnerabilities()
  fetchStats()
  fetchUsers()
})

const fetchVulnerabilities = async () => {
  loading.value = true
  try {
    const params = {
      skip: (pagination.currentPage - 1) * pagination.pageSize,
      limit: pagination.pageSize,
      search: searchQuery.value,
      severity: severityFilter.value,
      status: statusFilter.value,
      date_from: dateRange.value?.[0],
      date_to: dateRange.value?.[1]
    }
    const response = await vulnerabilityStore.getVulnerabilities(params)
    vulnerabilities.value = response.data || []
    pagination.total = response.total || 0
  } catch (error) {
    ElMessage.error('获取漏洞列表失败')
  } finally {
    loading.value = false
  }
}

const fetchStats = async () => {
  try {
    const response = await vulnerabilityStore.getVulnerabilityStats()
    Object.assign(stats, response)
  } catch (error) {
    console.error('Failed to fetch vulnerability stats:', error)
  }
}

const fetchUsers = async () => {
  try {
    const response = await userStore.getUsers({ limit: 100 })
    users.value = (response.data || []).filter(user =>
      user.role === 'security_analyst' || user.role === 'admin'
    )
  } catch (error) {
    console.error('Failed to fetch users:', error)
  }
}

const handleSearch = () => {
  pagination.currentPage = 1
  fetchVulnerabilities()
}

const handleDateChange = () => {
  pagination.currentPage = 1
  fetchVulnerabilities()
}

const handleSelectionChange = (selection) => {
  selectedVulns.value = selection
}

const handleSizeChange = (size) => {
  pagination.pageSize = size
  fetchVulnerabilities()
}

const handleCurrentChange = (page) => {
  pagination.currentPage = page
  fetchVulnerabilities()
}

const handleVerify = async (vulnerability) => {
  try {
    await vulnerabilityStore.verifyVulnerability(vulnerability.id)
    ElMessage.success('漏洞验证成功')
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('验证失败')
  }
}

const handleMarkFixed = async (vulnerability) => {
  await ElMessageBox.confirm('确定标记这个漏洞为已修复吗？', '确认操作', {
    type: 'success'
  })

  try {
    await vulnerabilityStore.updateVulnerabilityStatus(vulnerability.id, 'fixed')
    ElMessage.success('状态更新成功')
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('状态更新失败')
  }
}

const handleBulkVerify = async () => {
  const unverifiedVulns = selectedVulns.value.filter(v => !v.verified)

  if (unverifiedVulns.length === 0) {
    ElMessage.warning('没有可验证的漏洞')
    return
  }

  await ElMessageBox.confirm(
    `确定要验证选中的 ${unverifiedVulns.length} 个漏洞吗？`,
    '确认验证',
    { type: 'success' }
  )

  try {
    const ids = unverifiedVulns.map(v => v.id)
    await vulnerabilityStore.bulkVerify(ids)
    ElMessage.success('批量验证成功')
    selectedVulns.value = []
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('批量验证失败')
  }
}

const handleBulkIgnore = async () => {
  await ElMessageBox.confirm(
    `确定要忽略选中的 ${selectedVulns.value.length} 个漏洞吗？`,
    '确认忽略',
    { type: 'warning' }
  )

  try {
    const ids = selectedVulns.value.map(v => v.id)
    await vulnerabilityStore.bulkUpdateStatus(ids, 'ignored')
    ElMessage.success('批量忽略成功')
    selectedVulns.value = []
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('批量忽略失败')
  }
}

const handleBulkFix = async () => {
  await ElMessageBox.confirm(
    `确定要标记选中的 ${selectedVulns.value.length} 个漏洞为已修复吗？`,
    '确认标记',
    { type: 'success' }
  )

  try {
    const ids = selectedVulns.value.map(v => v.id)
    await vulnerabilityStore.bulkUpdateStatus(ids, 'fixed')
    ElMessage.success('批量标记成功')
    selectedVulns.value = []
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('批量标记失败')
  }
}

const handleCommand = async (command, vulnerability) => {
  switch (command) {
    case 'ignore':
      await updateVulnStatus(vulnerability, 'ignored')
      break
    case 'false_positive':
      await updateVulnStatus(vulnerability, 'false_positive')
      break
    case 'assign':
      assignForm.vulnerability_id = vulnerability.id
      assignDialogVisible.value = true
      break
    case 'export':
      await exportSingleVulnerability(vulnerability)
      break
  }
}

const updateVulnStatus = async (vulnerability, status) => {
  try {
    await vulnerabilityStore.updateVulnerabilityStatus(vulnerability.id, status)
    ElMessage.success('状态更新成功')
    fetchVulnerabilities()
    fetchStats()
  } catch (error) {
    ElMessage.error('状态更新失败')
  }
}

const confirmAssign = async () => {
  try {
    await vulnerabilityStore.assignVulnerability(
      assignForm.vulnerability_id,
      assignForm
    )
    ElMessage.success('分配成功')
    assignDialogVisible.value = false
    fetchVulnerabilities()
  } catch (error) {
    ElMessage.error('分配失败')
  }
}

const exportVulnerabilities = async () => {
  try {
    const data = await vulnerabilityStore.exportVulnerabilities({
      severity: severityFilter.value,
      status: statusFilter.value,
      date_from: dateRange.value?.[0],
      date_to: dateRange.value?.[1]
    })

    // Trigger download
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `vulnerabilities-${new Date().toISOString().split('T')[0]}.json`
    a.click()
    URL.revokeObjectURL(url)

    ElMessage.success('漏洞报告导出成功')
  } catch (error) {
    ElMessage.error('导出失败')
  }
}

const exportSingleVulnerability = async (vulnerability) => {
  try {
    const data = await vulnerabilityStore.exportVulnerability(vulnerability.id)

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `vulnerability-${vulnerability.name.replace(/[^a-zA-Z0-9]/g, '_')}.json`
    a.click()
    URL.revokeObjectURL(url)

    ElMessage.success('漏洞数据导出成功')
  } catch (error) {
    ElMessage.error('导出失败')
  }
}

const getRowClassName = ({ row }) => {
  if (row.severity === 'critical') return 'critical-row'
  if (row.severity === 'high') return 'high-row'
  return ''
}

// Helper functions
const getSeverityLabel = (severity) => {
  const labels = {
    critical: '严重',
    high: '高危',
    medium: '中危',
    low: '低危'
  }
  return labels[severity] || severity
}

const getSeverityTagType = (severity) => {
  const types = {
    critical: 'danger',
    high: 'warning',
    medium: 'info',
    low: 'success'
  }
  return types[severity] || 'info'
}

const getStatusLabel = (status) => {
  const labels = {
    open: '待修复',
    fixed: '已修复',
    false_positive: '误报',
    ignored: '已忽略'
  }
  return labels[status] || status
}

const getStatusTagType = (status) => {
  const types = {
    open: 'danger',
    fixed: 'success',
    false_positive: 'info',
    ignored: 'warning'
  }
  return types[status] || 'info'
}
</script>

<style scoped lang="scss">
.vulnerability-list {
  .page-header {
    margin-bottom: 24px;

    h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--el-text-color-primary);
    }

    p {
      color: var(--el-text-color-regular);
      margin: 0;
    }
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 16px;

    .toolbar-left {
      display: flex;
      gap: 12px;
    }

    .toolbar-right {
      display: flex;
      gap: 12px;
      align-items: center;

      .el-input {
        width: 200px;
      }

      .el-select {
        width: 120px;
      }

      .el-date-picker {
        width: 240px;
      }
    }
  }

  .stats-row {
    margin-bottom: 24px;

    .stat-card {
      text-align: center;
      position: relative;

      .stat-content {
        .stat-number {
          font-size: 28px;
          font-weight: bold;
          margin-bottom: 4px;
        }

        .stat-label {
          color: var(--el-text-color-regular);
          font-size: 14px;
        }
      }

      .stat-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        opacity: 0.3;
      }

      &.critical {
        .stat-number {
          color: var(--el-color-danger);
        }
        .stat-icon {
          color: var(--el-color-danger);
        }
      }

      &.high {
        .stat-number {
          color: var(--el-color-warning);
        }
        .stat-icon {
          color: var(--el-color-warning);
        }
      }

      &.medium {
        .stat-number {
          color: var(--el-color-info);
        }
        .stat-icon {
          color: var(--el-color-info);
        }
      }

      &.low {
        .stat-number {
          color: var(--el-color-success);
        }
        .stat-icon {
          color: var(--el-color-success);
        }
      }
    }
  }

  .vuln-name {
    .vuln-link {
      color: var(--el-color-primary);
      text-decoration: none;
      font-weight: 500;

      &:hover {
        text-decoration: underline;
      }
    }

    .cve-id {
      font-size: 12px;
      color: var(--el-text-color-secondary);
      margin-top: 2px;
    }
  }

  .asset-link,
  .task-link {
    color: var(--el-color-info);
    text-decoration: none;

    &:hover {
      text-decoration: underline;
    }
  }

  .cvss-score {
    font-weight: 500;
  }

  .pagination {
    margin-top: 20px;
    text-align: right;
  }

  :deep(.critical-row) {
    background-color: rgba(245, 108, 108, 0.05);
  }

  :deep(.high-row) {
    background-color: rgba(230, 162, 60, 0.05);
  }
}

@media (max-width: 768px) {
  .vulnerability-list .toolbar {
    flex-direction: column;
    align-items: stretch;

    .toolbar-left,
    .toolbar-right {
      justify-content: center;
    }

    .toolbar-right {
      .el-input,
      .el-select,
      .el-date-picker {
        width: 100%;
      }
    }
  }
}
</style>