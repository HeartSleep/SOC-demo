import { defineStore } from 'pinia'
import { ref } from 'vue'
import type { Vulnerability, VulnerabilityFilters } from '@/types/vulnerability'
import { request } from '@/utils/request'

export const useVulnerabilityStore = defineStore('vulnerability', () => {
  const vulnerabilities = ref<Vulnerability[]>([])
  const currentVulnerability = ref<Vulnerability | null>(null)
  const loading = ref(false)

  const getVulnerabilities = async (params?: VulnerabilityFilters) => {
    const response = await request.get('/vulnerabilities', { params })
    return response
  }

  const getVulnerability = async (id: string): Promise<Vulnerability> => {
    const response = await request.get(`/vulnerabilities/${id}`)
    return response
  }

  const updateVulnerabilityStatus = async (id: string, status: string): Promise<void> => {
    await request.put(`/vulnerabilities/${id}/status`, { status })
  }

  const verifyVulnerability = async (id: string): Promise<void> => {
    await request.post(`/vulnerabilities/${id}/verify`)
  }

  const bulkVerify = async (ids: string[]): Promise<void> => {
    await request.post('/vulnerabilities/bulk-verify', { ids })
  }

  const bulkUpdateStatus = async (ids: string[], status: string): Promise<void> => {
    await request.put('/vulnerabilities/bulk-status', { ids, status })
  }

  const assignVulnerability = async (id: string, data: any): Promise<void> => {
    await request.post(`/vulnerabilities/${id}/assign`, data)
  }

  const getVulnerabilityStats = async () => {
    const response = await request.get('/vulnerabilities/stats')
    return response
  }

  const exportVulnerabilities = async (params?: any) => {
    const response = await request.get('/vulnerabilities/export', { params })
    return response
  }

  const exportVulnerability = async (id: string) => {
    const response = await request.get(`/vulnerabilities/${id}/export`)
    return response
  }

  return {
    vulnerabilities,
    currentVulnerability,
    loading,
    getVulnerabilities,
    getVulnerability,
    updateVulnerabilityStatus,
    verifyVulnerability,
    bulkVerify,
    bulkUpdateStatus,
    assignVulnerability,
    getVulnerabilityStats,
    exportVulnerabilities,
    exportVulnerability
  }
})